<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.24">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Developing the employment heatmap visualization</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-62bd0246437ae56647c7d14e216fe155.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-814039ad842dfff7883839873f78e99b.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-62bd0246437ae56647c7d14e216fe155.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-752bec0286dddee11a9cb791c5aa2394.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-752bec0286dddee11a9cb791c5aa2394.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-752bec0286dddee11a9cb791c5aa2394.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="nav-sidebar floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="./index.html" class="navbar-brand navbar-brand-logo">
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./index.html" aria-current="page"> 
<span class="menu-text">Canada Employment Tracker</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-how" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">How</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-how">    
        <li>
    <a class="dropdown-item" href="./02_develop_visualization.html">
 <span class="dropdown-text">Developing the employment heatmap visualization</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./01_develop_data_processing.html">
 <span class="dropdown-text">Processing StatCan Data</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <a href="https://linkedin.com/in/victor2wy/" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-linkedin"></i></a>
    <a href="https://github.com/wvictor14/labourcan/" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./02_develop_visualization.html">Developing the employment heatmap visualization</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-center sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      </a>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_develop_visualization.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Developing the employment heatmap visualization</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_develop_data_processing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Processing StatCan Data</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">1</span> Introduction</a></li>
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup"><span class="header-section-number">2</span> Setup</a>
  <ul class="collapse">
  <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data"><span class="header-section-number">2.1</span> Data</a></li>
  <li><a href="#parameters" id="toc-parameters" class="nav-link" data-scroll-target="#parameters"><span class="header-section-number">2.2</span> Parameters</a></li>
  <li><a href="#dependencies" id="toc-dependencies" class="nav-link" data-scroll-target="#dependencies"><span class="header-section-number">2.3</span> Dependencies</a></li>
  <li><a href="#read-and-process-data-for-graphing" id="toc-read-and-process-data-for-graphing" class="nav-link" data-scroll-target="#read-and-process-data-for-graphing"><span class="header-section-number">2.4</span> Read and process data for graphing</a></li>
  </ul></li>
  <li><a href="#employment-heatmap" id="toc-employment-heatmap" class="nav-link" data-scroll-target="#employment-heatmap"><span class="header-section-number">3</span> Employment Heatmap</a>
  <ul class="collapse">
  <li><a href="#a-first-attempt" id="toc-a-first-attempt" class="nav-link" data-scroll-target="#a-first-attempt"><span class="header-section-number">3.1</span> A first attempt</a></li>
  <li><a href="#geom_point-or-geom_tile" id="toc-geom_point-or-geom_tile" class="nav-link" data-scroll-target="#geom_point-or-geom_tile"><span class="header-section-number">3.2</span> <code>geom_point</code> or <code>geom_tile</code></a></li>
  <li><a href="#explicit-color-mapping-with-scale_color_manual" id="toc-explicit-color-mapping-with-scale_color_manual" class="nav-link" data-scroll-target="#explicit-color-mapping-with-scale_color_manual"><span class="header-section-number">3.3</span> Explicit color mapping with <code>scale_color_manual</code></a>
  <ul class="collapse">
  <li><a href="#bin-with-polars.series.cut" id="toc-bin-with-polars.series.cut" class="nav-link" data-scroll-target="#bin-with-polars.series.cut"><span class="header-section-number">3.3.1</span> Bin with <code>polars.Series.cut</code></a></li>
  <li><a href="#scale_fill_manual-for-explicit-color-mapping" id="toc-scale_fill_manual-for-explicit-color-mapping" class="nav-link" data-scroll-target="#scale_fill_manual-for-explicit-color-mapping"><span class="header-section-number">3.3.2</span> <code>scale_fill_manual</code> for explicit color mapping</a></li>
  </ul></li>
  <li><a href="#customizing-the-plotnine-legend" id="toc-customizing-the-plotnine-legend" class="nav-link" data-scroll-target="#customizing-the-plotnine-legend"><span class="header-section-number">3.4</span> Customizing the <code>plotnine</code> legend</a></li>
  <li><a href="#text-and-fonts" id="toc-text-and-fonts" class="nav-link" data-scroll-target="#text-and-fonts"><span class="header-section-number">3.5</span> Text and fonts</a>
  <ul class="collapse">
  <li><a href="#consistent-theming-with-brand.yml" id="toc-consistent-theming-with-brand.yml" class="nav-link" data-scroll-target="#consistent-theming-with-brand.yml"><span class="header-section-number">3.5.1</span> Consistent theming with Brand.yml</a></li>
  <li><a href="#mizani-for-axis-breaks-and-labels" id="toc-mizani-for-axis-breaks-and-labels" class="nav-link" data-scroll-target="#mizani-for-axis-breaks-and-labels"><span class="header-section-number">3.5.2</span> <code>mizani</code> for axis breaks and labels</a></li>
  </ul></li>
  <li><a href="#conclusion-of-the-base-graphic" id="toc-conclusion-of-the-base-graphic" class="nav-link" data-scroll-target="#conclusion-of-the-base-graphic"><span class="header-section-number">3.6</span> Conclusion of the base graphic</a></li>
  </ul></li>
  <li><a href="#adding-more-layers" id="toc-adding-more-layers" class="nav-link" data-scroll-target="#adding-more-layers"><span class="header-section-number">4</span> Adding more layers</a>
  <ul class="collapse">
  <li><a href="#highlighting-an-industry" id="toc-highlighting-an-industry" class="nav-link" data-scroll-target="#highlighting-an-industry"><span class="header-section-number">4.1</span> Highlighting an Industry</a></li>
  <li><a href="#adding-statistics-to-the-plot" id="toc-adding-statistics-to-the-plot" class="nav-link" data-scroll-target="#adding-statistics-to-the-plot"><span class="header-section-number">4.2</span> Adding statistics to the plot</a></li>
  </ul></li>
  <li><a href="#appendix-things-that-didnt-work" id="toc-appendix-things-that-didnt-work" class="nav-link" data-scroll-target="#appendix-things-that-didnt-work"><span class="header-section-number">5</span> Appendix: Things that didn’t work</a>
  <ul class="collapse">
  <li><a href="#horizontal-legend-with-horizontal-legend-text" id="toc-horizontal-legend-with-horizontal-legend-text" class="nav-link" data-scroll-target="#horizontal-legend-with-horizontal-legend-text"><span class="header-section-number">5.1</span> Horizontal legend with horizontal legend text</a></li>
  <li><a href="#composing-in-plotnine-is-not-like-rs-patchwork" id="toc-composing-in-plotnine-is-not-like-rs-patchwork" class="nav-link" data-scroll-target="#composing-in-plotnine-is-not-like-rs-patchwork"><span class="header-section-number">5.2</span> Composing in plotnine is not like R’s patchwork</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Developing the employment heatmap visualization</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Current Canadian sentiment is at a low, with high cost-of-living, global political instability, and sweeping layoffs across multiple sectors. For the <a href="https://posit.co/blog/announcing-the-2025-table-and-plotnine-contests/">2025 <code>plotnine</code> contest</a>, I wanted to explore current official Canadian labour statistics using <code>plotnine</code>, a data visualization library in <code>python</code>.</p>
<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>I am so happy that <code>plotnine</code> exists, which is a relatively new python data visualization package. <code>plotnine</code> is based on <code>ggplot2</code>, an R package that I have been using for almost a decade.</p>
<p>In this tutorial, I’ll walk through the process of creating my <code>plotnine</code> 2025 contest submission. The plot shows employment across Canadian industries, ranked by their percent change in monthly employment. To help visualize data across different industries, industry-specific plots are laid out in a “pseudo” interactive manner.</p>
</section>
<section id="setup" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Setup</h1>
<section id="data" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="data"><span class="header-section-number">2.1</span> Data</h2>
<p>The data can be downloaded using this bash <a href="https://github.com/wvictor14/labourcan/blob/main/data/downloadLabourData.sh">script</a>, or directly from <a href="https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1410035502">StatCan’s website</a>.</p>
</section>
<section id="parameters" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="parameters"><span class="header-section-number">2.2</span> Parameters</h2>
<p>In this initial code chunk we initialize some parameters that, later if needed, we can rerun this entire notebook with different parameters (e.g.&nbsp;different years). Read more about Quarto parameters <a href="https://quarto.org/docs/computations/parameters.html">here</a>.</p>
<div id="7bf53856" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-1"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><a class="code-annotation-anchor" data-target-cell="annotated-cell-1" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-1-1" class="code-annotation-target"><a href="#annotated-cell-1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyprojroot <span class="im">import</span> here</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-1" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-1" data-code-lines="1" data-code-annotation="1"><code>pyprojroot</code> is similar to R’s package <code>here</code>, which lets us construct filepaths relative to the project root. This is very convenient especially for quarto projects with complex file organization.</span>
</dd>
</dl>
</div>
</div>
<div id="e37b236a" class="cell" data-tags="[&quot;parameters&quot;]" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>LABOUR_DATA_FILE <span class="op">=</span> here() <span class="op">/</span> <span class="st">"data"</span> <span class="op">/</span> <span class="st">"14100355.csv"</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>FIGURE_THEME_SIZE <span class="op">=</span> (<span class="dv">8</span>, <span class="dv">6</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>FILTER_YEAR <span class="op">=</span> (<span class="dv">2018</span>, <span class="dv">2025</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="dependencies" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="dependencies"><span class="header-section-number">2.3</span> Dependencies</h2>
<p>Now load the rest of the packages. Throughout this tutorial, I will describe when functions from each of these packages are being used.</p>
<div id="4131de73" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Data manipulation</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> polars <span class="im">as</span> pl</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> polars.selectors <span class="im">as</span> cs</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> date, datetime</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualization</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotnine <span class="im">import</span> <span class="op">*</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Mizani helps customize the text and breaks on axes</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mizani.bounds <span class="im">import</span> squish</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mizani.labels <span class="im">as</span> ml</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mizani.breaks <span class="im">as</span> mb</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> textwrap  <span class="co"># for wrapping long lines of text</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Custom extract and transform functions for plot data</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> labourcan.data_processing <span class="im">import</span> read_labourcan, calculate_centered_rank</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="read-and-process-data-for-graphing" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="read-and-process-data-for-graphing"><span class="header-section-number">2.4</span> Read and process data for graphing</h2>
<p>The visualization required a fair amount of data processing which is detailed in this <a href="01_develop_data_processing.html">page</a>. The steps are summarized here:</p>
<p><a href="../py/labourcan/data_processing.py"><code>read_labourcan</code></a> returns a <code>polars.Data.Frame</code> with:</p>
<ul>
<li>Unused columns removed</li>
<li>Filtered to seasonally adjusted estimates only</li>
<li>Filtered to Canada level estimates</li>
<li>Additional <code>YEAR</code>, <code>MONTH</code>, and <code>DATE_YMD</code> columns extracted from <code>REF_DATE</code></li>
<li>Sorted chronologically by year and month</li>
</ul>
<p>See <a href="02_develop_data_processing.html">labour.qmd</a> for details on data processing.</p>
<div id="533dd116" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>labour <span class="op">=</span> read_labourcan(LABOUR_DATA_FILE)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>labour_processed <span class="op">=</span> calculate_centered_rank(labour)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The data is several gigabytes large. Because of this, the data is not stored in the github repo. Please use this <a href="https://github.com/wvictor14/labourcan/blob/main/data/downloadLabourData.sh">script</a> to download the data.</p>
</section>
</section>
<section id="employment-heatmap" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Employment Heatmap</h1>
<section id="a-first-attempt" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="a-first-attempt"><span class="header-section-number">3.1</span> A first attempt</h2>
<p>The type of graphic that we’re developing today can be described as something like a <a href="https://plotnine.org/reference/examples/scale_fill_continuous-preview.html">heatmap</a> of employment numbers.</p>
<p>The motivation is to tell a story about Canada’s job sector, and specifically the variation in employment numbers over time. Thefore, I wanted to create a visualization that would clearly separate industries that are <em>growing</em> versus <em>shrinking</em>.</p>
<p>Therefore, I derived a rank ordering by % monthly changed, but that is centered around <code>0</code>, such that growing sectors with a positive % change will have a positive ranking and shrinking sectors will have a negative one. The ranking will start at <code>1</code> / <code>-1</code>, and increase / decrease away from <code>0</code>. See <a href="https://github.com/wvictor14/labourcan/blob/main/py/labourcan/data_processing.py"><code>calculate_centered_rank</code></a> for implementation details.</p>
<div id="1ec7944a" class="cell" data-page-layout="column-page" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-5"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-5-1"><a href="#annotated-cell-5-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="annotated-cell-5-2"><a href="#annotated-cell-5-2" aria-hidden="true" tabindex="-1"></a>    ggplot(</span>
<span id="annotated-cell-5-3"><a href="#annotated-cell-5-3" aria-hidden="true" tabindex="-1"></a>        (</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-5" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-5-4" class="code-annotation-target"><a href="#annotated-cell-5-4" aria-hidden="true" tabindex="-1"></a>            labour_processed.<span class="bu">filter</span>(</span>
<span id="annotated-cell-5-5"><a href="#annotated-cell-5-5" aria-hidden="true" tabindex="-1"></a>                pl.col(<span class="st">"YEAR"</span>) <span class="op">&gt;=</span> FILTER_YEAR[<span class="dv">0</span>], pl.col(<span class="st">"YEAR"</span>) <span class="op">&lt;=</span> FILTER_YEAR[<span class="dv">1</span>]</span>
<span id="annotated-cell-5-6"><a href="#annotated-cell-5-6" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="annotated-cell-5-7"><a href="#annotated-cell-5-7" aria-hidden="true" tabindex="-1"></a>        ),</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-5" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-5-8" class="code-annotation-target"><a href="#annotated-cell-5-8" aria-hidden="true" tabindex="-1"></a>        aes(x<span class="op">=</span><span class="st">"DATE_YMD"</span>, y<span class="op">=</span><span class="st">"centered_rank_across_industry"</span>, color<span class="op">=</span><span class="st">"PDIFF"</span>),</span>
<span id="annotated-cell-5-9"><a href="#annotated-cell-5-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="annotated-cell-5-10"><a href="#annotated-cell-5-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> geom_point(shape<span class="op">=</span><span class="st">"s"</span>)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-5" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-5-11" class="code-annotation-target"><a href="#annotated-cell-5-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme_tufte()</span>
<span id="annotated-cell-5-12"><a href="#annotated-cell-5-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme(figure_size<span class="op">=</span>FIGURE_THEME_SIZE, axis_text_x<span class="op">=</span>element_text(angle<span class="op">=</span><span class="dv">90</span>))</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-5" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-5-13" class="code-annotation-target"><a href="#annotated-cell-5-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> scale_color_gradient2(</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-5" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-5-14" class="code-annotation-target"><a href="#annotated-cell-5-14" aria-hidden="true" tabindex="-1"></a>        limits<span class="op">=</span>(<span class="op">-</span><span class="fl">0.01</span>, <span class="fl">0.01</span>), low<span class="op">=</span><span class="st">"#ff0000ff"</span>, high<span class="op">=</span><span class="st">"#0000dbff"</span>, midpoint<span class="op">=</span><span class="dv">0</span>, oob<span class="op">=</span>squish</span>
<span id="annotated-cell-5-15"><a href="#annotated-cell-5-15" aria-hidden="true" tabindex="-1"></a>    ) </span>
<span id="annotated-cell-5-16"><a href="#annotated-cell-5-16" aria-hidden="true" tabindex="-1"></a>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-5" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-5" data-code-lines="4" data-code-annotation="1">We filter the data inline so that we can easily interactively develop our graphic</span>
</dd>
<dt data-target-cell="annotated-cell-5" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-5" data-code-lines="8" data-code-annotation="2">We use <code>aes</code> to map our variables: <code>DATE_YMD</code> (date in datetime format) to <code>x</code>, ranking (i64) to <code>y</code>, and color each point by the percent monthly change <code>PDIFF</code> (f64).</span>
</dd>
<dt data-target-cell="annotated-cell-5" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-5" data-code-lines="11" data-code-annotation="3">I like to start with relatively minimal theme, such as <code>theme_tufte</code> as a base to build up customizations</span>
</dd>
<dt data-target-cell="annotated-cell-5" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-5" data-code-lines="13" data-code-annotation="4"><code>scale_color_gradient2</code> is a great color mapping function because it can allow us to easily specify that we want a palette that centers around a midpoint (<code>0</code>).</span>
</dd>
<dt data-target-cell="annotated-cell-5" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-5" data-code-lines="14" data-code-annotation="5">The <code>limits=c(-0.01, 0.01)</code> and <code>oob=squish</code> is very impactful here, which in combination makes the color palette stop at a -1% and +1%, everything that is beyond these limits will take on the darkest colors.</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_develop_visualization_files/figure-html/cell-6-output-1.png" width="768" height="576" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="geom_point-or-geom_tile" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="geom_point-or-geom_tile"><span class="header-section-number">3.2</span> <code>geom_point</code> or <code>geom_tile</code></h2>
<p>I like to start shaping plots by starting with the major components, which <code>geom</code> is most appropriate for this type of data?</p>
<p>This first version has quite a bit of whitespace between each point, which I find is distracting. I could make the point size larger, but the ratio of point size to the range of the x and y axis, as well as the figure size all will ultimately determine how much whitespace remains between each point. This makes sizing tricky.</p>
<p>If we use <code>geom_tile</code> instead, which will plot rectangles specified by a center point, we can explicitly control the whitespace between tiles.</p>
<div id="cd63913b" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-6"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-6-1"><a href="#annotated-cell-6-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="annotated-cell-6-2"><a href="#annotated-cell-6-2" aria-hidden="true" tabindex="-1"></a>    ggplot(</span>
<span id="annotated-cell-6-3"><a href="#annotated-cell-6-3" aria-hidden="true" tabindex="-1"></a>        (</span>
<span id="annotated-cell-6-4"><a href="#annotated-cell-6-4" aria-hidden="true" tabindex="-1"></a>            labour_processed.<span class="bu">filter</span>(</span>
<span id="annotated-cell-6-5"><a href="#annotated-cell-6-5" aria-hidden="true" tabindex="-1"></a>                pl.col(<span class="st">"YEAR"</span>) <span class="op">&gt;=</span> FILTER_YEAR[<span class="dv">0</span>], pl.col(<span class="st">"YEAR"</span>) <span class="op">&lt;=</span> FILTER_YEAR[<span class="dv">1</span>]</span>
<span id="annotated-cell-6-6"><a href="#annotated-cell-6-6" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="annotated-cell-6-7"><a href="#annotated-cell-6-7" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="annotated-cell-6-8"><a href="#annotated-cell-6-8" aria-hidden="true" tabindex="-1"></a>        aes(x<span class="op">=</span><span class="st">"DATE_YMD"</span>, y<span class="op">=</span><span class="st">"centered_rank_across_industry"</span>, fill<span class="op">=</span><span class="st">"PDIFF"</span>),</span>
<span id="annotated-cell-6-9"><a href="#annotated-cell-6-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-6-10" class="code-annotation-target"><a href="#annotated-cell-6-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> geom_tile(height<span class="op">=</span><span class="fl">0.95</span>, width<span class="op">=</span><span class="dv">30</span> <span class="op">*</span> <span class="fl">0.95</span>)</span>
<span id="annotated-cell-6-11"><a href="#annotated-cell-6-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme_tufte()</span>
<span id="annotated-cell-6-12"><a href="#annotated-cell-6-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme(figure_size<span class="op">=</span>FIGURE_THEME_SIZE, axis_text_x<span class="op">=</span>element_text(angle<span class="op">=</span><span class="dv">90</span>))</span>
<span id="annotated-cell-6-13"><a href="#annotated-cell-6-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> scale_fill_gradient2(</span>
<span id="annotated-cell-6-14"><a href="#annotated-cell-6-14" aria-hidden="true" tabindex="-1"></a>        limits<span class="op">=</span>(<span class="op">-</span><span class="fl">0.01</span>, <span class="fl">0.01</span>), low<span class="op">=</span><span class="st">"#ff0000ff"</span>, high<span class="op">=</span><span class="st">"#0000dbff"</span>, midpoint<span class="op">=</span><span class="dv">0</span>, oob<span class="op">=</span>squish</span>
<span id="annotated-cell-6-15"><a href="#annotated-cell-6-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="annotated-cell-6-16"><a href="#annotated-cell-6-16" aria-hidden="true" tabindex="-1"></a>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-6" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-6" data-code-lines="10" data-code-annotation="1"><code>height = 0.95</code> leaves a small amount of whitespace between tiles vertically. To remove horizontal whitespace, we need to specify a <code>width</code>. Because we are using a <code>datetime</code> axis, we need to specify it in unit of days. But each tile here is a month, so we need to express in units of 30, hence: <code>width = 30*0.95</code>.</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_develop_visualization_files/figure-html/cell-7-output-1.png" width="768" height="576" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="explicit-color-mapping-with-scale_color_manual" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="explicit-color-mapping-with-scale_color_manual"><span class="header-section-number">3.3</span> Explicit color mapping with <code>scale_color_manual</code></h2>
<p><code>scale_fill_gradient2</code> used with <code>squish</code> creates a nice palette that’s centered around 0. However <code>scale_fill_gradient2</code> is limited to 3 colors (<code>high</code>, <code>midpoint</code>, <code>low</code>), but I would like to highlight variability in the data with a lot more control than what these 3 points can provide.</p>
<p>To be more explicit with the colors, I will bin the % change variable and then map each bin to a color manually using <code>scale_fill_manual</code>.</p>
<section id="bin-with-polars.series.cut" class="level3" data-number="3.3.1">
<h3 data-number="3.3.1" class="anchored" data-anchor-id="bin-with-polars.series.cut"><span class="header-section-number">3.3.1</span> Bin with <code>polars.Series.cut</code></h3>
<p>Binning is the process of breaking up a continuous variable into categories based on specific thresholds.</p>
<div id="c5c2257b" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>labour_processed_cutted <span class="op">=</span> (</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    labour_processed.with_columns(</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>        pl.col(<span class="st">"PDIFF"</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>        .cut(</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>            [</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>                <span class="op">-</span><span class="fl">0.05</span>,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>                <span class="op">-</span><span class="fl">0.025</span>,</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>                <span class="op">-</span><span class="fl">0.012</span>,</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>                <span class="op">-</span><span class="fl">0.0080</span>,</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>                <span class="op">-</span><span class="fl">0.0040</span>,</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>                <span class="dv">0</span>,</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>                <span class="fl">0.0040</span>,</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>                <span class="fl">0.0080</span>,</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>                <span class="fl">0.012</span>,</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>                <span class="fl">0.025</span>,</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>                <span class="fl">0.05</span>,</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>        .alias(<span class="st">"PDIFF_BINNED"</span>)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    .with_columns(</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>        pl.when(pl.col(<span class="st">"PDIFF"</span>) <span class="op">==</span> <span class="dv">0</span>)</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>        .then(pl.lit(<span class="st">"0"</span>))</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>        .otherwise(pl.col(<span class="st">"PDIFF_BINNED"</span>))</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>        .alias(<span class="st">"PDIFF_BINNED"</span>)</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    .sort(<span class="st">"PDIFF"</span>)</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    .with_columns(pl.col(<span class="st">"PDIFF_BINNED"</span>))</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>labour_processed_cutted.group_by(<span class="st">"PDIFF_BINNED"</span>).<span class="bu">len</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (14, 2)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">PDIFF_BINNED</th>
<th data-quarto-table-cell-role="th">len</th>
</tr>
<tr class="even">
<td>cat</td>
<td>u32</td>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>"(-inf, -0.05]"</td>
<td>47</td>
</tr>
<tr class="even">
<td>"(0.004, 0.008]"</td>
<td>1736</td>
</tr>
<tr class="odd">
<td>"(-0.05, -0.025]"</td>
<td>255</td>
</tr>
<tr class="even">
<td>"(-0.025, -0.012]"</td>
<td>892</td>
</tr>
<tr class="odd">
<td>"(0.05, inf]"</td>
<td>58</td>
</tr>
<tr class="even">
<td>…</td>
<td>…</td>
</tr>
<tr class="odd">
<td>null</td>
<td>21</td>
</tr>
<tr class="even">
<td>"(0.008, 0.012]"</td>
<td>1021</td>
</tr>
<tr class="odd">
<td>"(-0.008, -0.004]"</td>
<td>1201</td>
</tr>
<tr class="even">
<td>"(0.012, 0.025]"</td>
<td>1292</td>
</tr>
<tr class="odd">
<td>"(0.025, 0.05]"</td>
<td>315</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>After binning the data by % change, we can see what happens when we map color to this new binned version:</p>
<div id="a6d2da86" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-8"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-8-1"><a href="#annotated-cell-8-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="annotated-cell-8-2"><a href="#annotated-cell-8-2" aria-hidden="true" tabindex="-1"></a>    ggplot(</span>
<span id="annotated-cell-8-3"><a href="#annotated-cell-8-3" aria-hidden="true" tabindex="-1"></a>        (</span>
<span id="annotated-cell-8-4"><a href="#annotated-cell-8-4" aria-hidden="true" tabindex="-1"></a>            labour_processed_cutted.<span class="bu">filter</span>(</span>
<span id="annotated-cell-8-5"><a href="#annotated-cell-8-5" aria-hidden="true" tabindex="-1"></a>                pl.col(<span class="st">"YEAR"</span>) <span class="op">&gt;=</span> FILTER_YEAR[<span class="dv">0</span>], pl.col(<span class="st">"YEAR"</span>) <span class="op">&lt;=</span> FILTER_YEAR[<span class="dv">1</span>]</span>
<span id="annotated-cell-8-6"><a href="#annotated-cell-8-6" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="annotated-cell-8-7"><a href="#annotated-cell-8-7" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="annotated-cell-8-8"><a href="#annotated-cell-8-8" aria-hidden="true" tabindex="-1"></a>        aes(</span>
<span id="annotated-cell-8-9"><a href="#annotated-cell-8-9" aria-hidden="true" tabindex="-1"></a>            x<span class="op">=</span><span class="st">"DATE_YMD"</span>,</span>
<span id="annotated-cell-8-10"><a href="#annotated-cell-8-10" aria-hidden="true" tabindex="-1"></a>            y<span class="op">=</span><span class="st">"centered_rank_across_industry"</span>,</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-8-11" class="code-annotation-target"><a href="#annotated-cell-8-11" aria-hidden="true" tabindex="-1"></a>            fill<span class="op">=</span><span class="st">"PDIFF_BINNED"</span>,</span>
<span id="annotated-cell-8-12"><a href="#annotated-cell-8-12" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="annotated-cell-8-13"><a href="#annotated-cell-8-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="annotated-cell-8-14"><a href="#annotated-cell-8-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> geom_tile(height<span class="op">=</span><span class="fl">0.95</span>) </span>
<span id="annotated-cell-8-15"><a href="#annotated-cell-8-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme_tufte()</span>
<span id="annotated-cell-8-16"><a href="#annotated-cell-8-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme(figure_size<span class="op">=</span>FIGURE_THEME_SIZE, axis_text_x<span class="op">=</span>element_text(angle<span class="op">=</span><span class="dv">90</span>))</span>
<span id="annotated-cell-8-17"><a href="#annotated-cell-8-17" aria-hidden="true" tabindex="-1"></a>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-8" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="11" data-code-annotation="1">Here, <code>plotnine</code> sees that we mapped a categorical variable to <code>fill</code>, so it uses a default palette that isn’t necessarily optimized for the continuous (ie. ordinal) nature of bins. To offend even further, we can see that the categories are not even by default ordered correctly (most negative to most positive).</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_develop_visualization_files/figure-html/cell-9-output-1.png" width="768" height="576" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>It’s definitely uglier, not nicer. But that’s ok, it’s giving us finer control, and we’re going to use that to fix this in the next section…</p>
</section>
<section id="scale_fill_manual-for-explicit-color-mapping" class="level3" data-number="3.3.2">
<h3 data-number="3.3.2" class="anchored" data-anchor-id="scale_fill_manual-for-explicit-color-mapping"><span class="header-section-number">3.3.2</span> <code>scale_fill_manual</code> for explicit color mapping</h3>
<p>Now we need to order the levels, and map to a specific color palette.</p>
<p>We will make <code>PDIFF=0%</code> (no change) to be gray, positive values to have <code>green</code> and <code>blue</code> colors (<em>growth</em> = <em>good</em>), and negative values to be <code>red</code> and <code>orange</code> (<em>contraction</em> = <em>bad</em>) colors.</p>
<div id="b35d05a7" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-9"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-9-1"><a href="#annotated-cell-9-1" aria-hidden="true" tabindex="-1"></a>order <span class="op">=</span> (</span>
<span id="annotated-cell-9-2"><a href="#annotated-cell-9-2" aria-hidden="true" tabindex="-1"></a>    labour_processed_cutted.drop_nulls()</span>
<span id="annotated-cell-9-3"><a href="#annotated-cell-9-3" aria-hidden="true" tabindex="-1"></a>    .sort(<span class="st">"PDIFF"</span>)</span>
<span id="annotated-cell-9-4"><a href="#annotated-cell-9-4" aria-hidden="true" tabindex="-1"></a>    .select(pl.col(<span class="st">"PDIFF_BINNED"</span>))</span>
<span id="annotated-cell-9-5"><a href="#annotated-cell-9-5" aria-hidden="true" tabindex="-1"></a>    .unique(maintain_order<span class="op">=</span><span class="va">True</span>)</span>
<span id="annotated-cell-9-6"><a href="#annotated-cell-9-6" aria-hidden="true" tabindex="-1"></a>    .to_series()</span>
<span id="annotated-cell-9-7"><a href="#annotated-cell-9-7" aria-hidden="true" tabindex="-1"></a>    .to_list()</span>
<span id="annotated-cell-9-8"><a href="#annotated-cell-9-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="annotated-cell-9-9"><a href="#annotated-cell-9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-9-10"><a href="#annotated-cell-9-10" aria-hidden="true" tabindex="-1"></a>labour_processed_cutted_ordered <span class="op">=</span> labour_processed_cutted.with_columns(</span>
<span id="annotated-cell-9-11"><a href="#annotated-cell-9-11" aria-hidden="true" tabindex="-1"></a>    pl.col(<span class="st">"PDIFF_BINNED"</span>).cast(pl.Enum(order))</span>
<span id="annotated-cell-9-12"><a href="#annotated-cell-9-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="annotated-cell-9-13"><a href="#annotated-cell-9-13" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-9" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-9-14" class="code-annotation-target"><a href="#annotated-cell-9-14" aria-hidden="true" tabindex="-1"></a>color_mapping <span class="op">=</span> {</span>
<span id="annotated-cell-9-15"><a href="#annotated-cell-9-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"(-inf, -0.05]"</span>: <span class="st">"#d82828ff"</span>,</span>
<span id="annotated-cell-9-16"><a href="#annotated-cell-9-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"(-0.05, -0.025]"</span>: <span class="st">"#fa6f1fff"</span>,</span>
<span id="annotated-cell-9-17"><a href="#annotated-cell-9-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"(-0.025, -0.012]"</span>: <span class="st">"#f1874aff"</span>,</span>
<span id="annotated-cell-9-18"><a href="#annotated-cell-9-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"(-0.012, -0.008]"</span>: <span class="st">"#f1b274ff"</span>,</span>
<span id="annotated-cell-9-19"><a href="#annotated-cell-9-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"(-0.008, -0.004]"</span>: <span class="st">"#FEE08B"</span>,</span>
<span id="annotated-cell-9-20"><a href="#annotated-cell-9-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"(-0.004, 0]"</span>: <span class="st">"#FFFFBF"</span>,</span>
<span id="annotated-cell-9-21"><a href="#annotated-cell-9-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"0"</span>: <span class="st">"#a8a8a8ff"</span>,</span>
<span id="annotated-cell-9-22"><a href="#annotated-cell-9-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"(0, 0.004]"</span>: <span class="st">"#E6F5D0"</span>,</span>
<span id="annotated-cell-9-23"><a href="#annotated-cell-9-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"(0.004, 0.008]"</span>: <span class="st">"#bce091ff"</span>,</span>
<span id="annotated-cell-9-24"><a href="#annotated-cell-9-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"(0.008, 0.012]"</span>: <span class="st">"#9ad65fff"</span>,</span>
<span id="annotated-cell-9-25"><a href="#annotated-cell-9-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"(0.012, 0.025]"</span>: <span class="st">"#78b552ff"</span>,</span>
<span id="annotated-cell-9-26"><a href="#annotated-cell-9-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"(0.025, 0.05]"</span>: <span class="st">"#5cb027ff"</span>,</span>
<span id="annotated-cell-9-27"><a href="#annotated-cell-9-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"(0.05, inf]"</span>: <span class="st">"#1f6fc6ff"</span>,</span>
<span id="annotated-cell-9-28"><a href="#annotated-cell-9-28" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="annotated-cell-9-29"><a href="#annotated-cell-9-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-9-30"><a href="#annotated-cell-9-30" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="annotated-cell-9-31"><a href="#annotated-cell-9-31" aria-hidden="true" tabindex="-1"></a>    ggplot(</span>
<span id="annotated-cell-9-32"><a href="#annotated-cell-9-32" aria-hidden="true" tabindex="-1"></a>        (</span>
<span id="annotated-cell-9-33"><a href="#annotated-cell-9-33" aria-hidden="true" tabindex="-1"></a>            labour_processed_cutted.<span class="bu">filter</span>(</span>
<span id="annotated-cell-9-34"><a href="#annotated-cell-9-34" aria-hidden="true" tabindex="-1"></a>                pl.col(<span class="st">"YEAR"</span>) <span class="op">&gt;=</span> FILTER_YEAR[<span class="dv">0</span>], pl.col(<span class="st">"YEAR"</span>) <span class="op">&lt;=</span> FILTER_YEAR[<span class="dv">1</span>]</span>
<span id="annotated-cell-9-35"><a href="#annotated-cell-9-35" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="annotated-cell-9-36"><a href="#annotated-cell-9-36" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="annotated-cell-9-37"><a href="#annotated-cell-9-37" aria-hidden="true" tabindex="-1"></a>        aes(x<span class="op">=</span><span class="st">"DATE_YMD"</span>, y<span class="op">=</span><span class="st">"centered_rank_across_industry"</span>, fill<span class="op">=</span><span class="st">"PDIFF_BINNED"</span>), </span>
<span id="annotated-cell-9-38"><a href="#annotated-cell-9-38" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="annotated-cell-9-39"><a href="#annotated-cell-9-39" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> geom_tile(color<span class="op">=</span><span class="st">"white"</span>)</span>
<span id="annotated-cell-9-40"><a href="#annotated-cell-9-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme_tufte()</span>
<span id="annotated-cell-9-41"><a href="#annotated-cell-9-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme(figure_size<span class="op">=</span>FIGURE_THEME_SIZE, axis_text_x<span class="op">=</span>element_text(angle<span class="op">=</span><span class="dv">90</span>))</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-9" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-9-42" class="code-annotation-target"><a href="#annotated-cell-9-42" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> scale_fill_manual(values<span class="op">=</span>color_mapping, breaks<span class="op">=</span>order)</span>
<span id="annotated-cell-9-43"><a href="#annotated-cell-9-43" aria-hidden="true" tabindex="-1"></a>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-9" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-9" data-code-lines="14" data-code-annotation="1">First, we define a dictionary that specifies an explicit mapping of bins to color</span>
</dd>
<dt data-target-cell="annotated-cell-9" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-9" data-code-lines="42" data-code-annotation="2">Then, we provide the dictionary to <code>values</code> in <code>scale_fill_manual</code></span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_develop_visualization_files/figure-html/cell-10-output-1.png" width="768" height="576" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Now we have a much nicer looking color palette for our graphic. This process illustrates a few things:</p>
<ul>
<li><code>scale_fill_gradient2</code>
<ul>
<li>Worked well “out-of-the-box”</li>
<li>But is limited for more fine-grained control over the gradient</li>
</ul></li>
<li><code>scale_fill_manual</code> plus our binning procedure
<ul>
<li>allows us to explicitly control how color is mapped to the data.</li>
<li>For example, this approach allows us to highlight more extreme values with how we define extreme (e.g.&nbsp;&gt;+5%, &lt;-5%), or non significant data (0% no change)</li>
<li>But the cost was that it takes a lot more effort and lines of code</li>
</ul></li>
</ul>
</section>
</section>
<section id="customizing-the-plotnine-legend" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="customizing-the-plotnine-legend"><span class="header-section-number">3.4</span> Customizing the <code>plotnine</code> legend</h2>
<p>… which in its current form, is mathematically accurate, but we can make it much nicer to look at.</p>
<p>Let’s start by making the text more concise:</p>
<ul>
<li>We don’t need every bin to be labelled</li>
<li>Instead of listing the range, we can just describe the midpoint</li>
</ul>
<div id="c787232b" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-10"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><a class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-10-1" class="code-annotation-target"><a href="#annotated-cell-10-1" aria-hidden="true" tabindex="-1"></a>legend_labels <span class="op">=</span> [</span>
<span id="annotated-cell-10-2"><a href="#annotated-cell-10-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"-5%"</span>,  <span class="co"># the ends can be labelled with the boundary e.g. implies &lt;-5%</span></span>
<span id="annotated-cell-10-3"><a href="#annotated-cell-10-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">""</span>,</span>
<span id="annotated-cell-10-4"><a href="#annotated-cell-10-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">""</span>,</span>
<span id="annotated-cell-10-5"><a href="#annotated-cell-10-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"-1%"</span>,</span>
<span id="annotated-cell-10-6"><a href="#annotated-cell-10-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">""</span>,</span>
<span id="annotated-cell-10-7"><a href="#annotated-cell-10-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">""</span>,</span>
<span id="annotated-cell-10-8"><a href="#annotated-cell-10-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"No change"</span>,</span>
<span id="annotated-cell-10-9"><a href="#annotated-cell-10-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">""</span>,</span>
<span id="annotated-cell-10-10"><a href="#annotated-cell-10-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">""</span>,</span>
<span id="annotated-cell-10-11"><a href="#annotated-cell-10-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">""</span>,</span>
<span id="annotated-cell-10-12"><a href="#annotated-cell-10-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"1%"</span>,</span>
<span id="annotated-cell-10-13"><a href="#annotated-cell-10-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">""</span>,</span>
<span id="annotated-cell-10-14"><a href="#annotated-cell-10-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"5%"</span>,</span>
<span id="annotated-cell-10-15"><a href="#annotated-cell-10-15" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="annotated-cell-10-16"><a href="#annotated-cell-10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-17"><a href="#annotated-cell-10-17" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="annotated-cell-10-18"><a href="#annotated-cell-10-18" aria-hidden="true" tabindex="-1"></a>    ggplot(</span>
<span id="annotated-cell-10-19"><a href="#annotated-cell-10-19" aria-hidden="true" tabindex="-1"></a>        labour_processed_cutted.<span class="bu">filter</span>(</span>
<span id="annotated-cell-10-20"><a href="#annotated-cell-10-20" aria-hidden="true" tabindex="-1"></a>            pl.col(<span class="st">"YEAR"</span>) <span class="op">&gt;=</span> FILTER_YEAR[<span class="dv">0</span>], pl.col(<span class="st">"YEAR"</span>) <span class="op">&lt;=</span> FILTER_YEAR[<span class="dv">1</span>]</span>
<span id="annotated-cell-10-21"><a href="#annotated-cell-10-21" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="annotated-cell-10-22"><a href="#annotated-cell-10-22" aria-hidden="true" tabindex="-1"></a>        aes(x<span class="op">=</span><span class="st">"DATE_YMD"</span>, y<span class="op">=</span><span class="st">"centered_rank_across_industry"</span>, fill<span class="op">=</span><span class="st">"PDIFF_BINNED"</span>),</span>
<span id="annotated-cell-10-23"><a href="#annotated-cell-10-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="annotated-cell-10-24"><a href="#annotated-cell-10-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> geom_tile(color<span class="op">=</span><span class="st">"white"</span>)</span>
<span id="annotated-cell-10-25"><a href="#annotated-cell-10-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme_tufte()</span>
<span id="annotated-cell-10-26"><a href="#annotated-cell-10-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme(</span>
<span id="annotated-cell-10-27"><a href="#annotated-cell-10-27" aria-hidden="true" tabindex="-1"></a>        figure_size<span class="op">=</span>FIGURE_THEME_SIZE,</span>
<span id="annotated-cell-10-28"><a href="#annotated-cell-10-28" aria-hidden="true" tabindex="-1"></a>        axis_text_x<span class="op">=</span>element_text(angle<span class="op">=</span><span class="dv">90</span>),</span>
<span id="annotated-cell-10-29"><a href="#annotated-cell-10-29" aria-hidden="true" tabindex="-1"></a>        legend_justification_right<span class="op">=</span><span class="dv">1</span>,</span>
<span id="annotated-cell-10-30"><a href="#annotated-cell-10-30" aria-hidden="true" tabindex="-1"></a>        legend_position<span class="op">=</span><span class="st">"right"</span>,</span>
<span id="annotated-cell-10-31"><a href="#annotated-cell-10-31" aria-hidden="true" tabindex="-1"></a>        legend_text_position<span class="op">=</span><span class="st">"right"</span>,</span>
<span id="annotated-cell-10-32"><a href="#annotated-cell-10-32" aria-hidden="true" tabindex="-1"></a>        legend_title<span class="op">=</span>element_blank(),</span>
<span id="annotated-cell-10-33"><a href="#annotated-cell-10-33" aria-hidden="true" tabindex="-1"></a>        legend_key_spacing<span class="op">=</span><span class="dv">0</span>,</span>
<span id="annotated-cell-10-34"><a href="#annotated-cell-10-34" aria-hidden="true" tabindex="-1"></a>        legend_key_width<span class="op">=</span><span class="dv">10</span>,</span>
<span id="annotated-cell-10-35"><a href="#annotated-cell-10-35" aria-hidden="true" tabindex="-1"></a>        legend_key_height<span class="op">=</span><span class="dv">10</span>,</span>
<span id="annotated-cell-10-36"><a href="#annotated-cell-10-36" aria-hidden="true" tabindex="-1"></a>        legend_text<span class="op">=</span>element_text(size<span class="op">=</span><span class="dv">8</span>),</span>
<span id="annotated-cell-10-37"><a href="#annotated-cell-10-37" aria-hidden="true" tabindex="-1"></a>    )</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-10-38" class="code-annotation-target"><a href="#annotated-cell-10-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> scale_fill_manual(</span>
<span id="annotated-cell-10-39"><a href="#annotated-cell-10-39" aria-hidden="true" tabindex="-1"></a>        values<span class="op">=</span>color_mapping, breaks<span class="op">=</span>order, labels<span class="op">=</span>legend_labels</span>
<span id="annotated-cell-10-40"><a href="#annotated-cell-10-40" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="annotated-cell-10-41"><a href="#annotated-cell-10-41" aria-hidden="true" tabindex="-1"></a>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-10" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="1" data-code-annotation="1">Similar to <code>values</code>, for <code>labels</code> we define a list that is the same length as the <code>breaks</code></span>
</dd>
<dt data-target-cell="annotated-cell-10" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="38" data-code-annotation="2">And then we provide the list <code>legend_labels</code> to <code>scale_fill_manual</code></span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_develop_visualization_files/figure-html/cell-11-output-1.png" width="768" height="576" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>I originally wanted to make a <a href="#horizontal-legend-with-horizontal-legend-text">horizontal legend</a>, but this works much better.</p>
</section>
<section id="text-and-fonts" class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="text-and-fonts"><span class="header-section-number">3.5</span> Text and fonts</h2>
<p>Next up is the text and fonts. I played with a few fonts on <a href="https://fonts.google.com/">google fonts</a> before settling on two. Note that this website uses these fonts with the help of <a href="_brand.yml">brand.yml</a></p>
<p>Install the fonts:</p>
<div id="4999f00a" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>FONT_PRIMARY <span class="op">=</span> <span class="st">"Playfair Display"</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>FONT_SECONDARY <span class="op">=</span> <span class="st">"Lato"</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mpl_fontkit <span class="im">as</span> fk</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>fk.install(FONT_PRIMARY)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>fk.install(FONT_SECONDARY)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Font name: `Playfair Display`
Font name: `Lato`</code></pre>
</div>
</div>
<section id="consistent-theming-with-brand.yml" class="level3" data-number="3.5.1">
<h3 data-number="3.5.1" class="anchored" data-anchor-id="consistent-theming-with-brand.yml"><span class="header-section-number">3.5.1</span> Consistent theming with Brand.yml</h3>
<p>Alternatively, if we utilize <a href="https://github.com/wvictor14/labourcan/blob/main/_brand.yml"><code>brand.yml</code></a>, we can pull these settings directly from it.</p>
<div id="425ab6d8" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-12"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-12-1"><a href="#annotated-cell-12-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> brand_yml <span class="im">import</span> Brand</span>
<span id="annotated-cell-12-2"><a href="#annotated-cell-12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-3"><a href="#annotated-cell-12-3" aria-hidden="true" tabindex="-1"></a>BRAND <span class="op">=</span> Brand.from_yaml(here())</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-12" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-12-4" class="code-annotation-target"><a href="#annotated-cell-12-4" aria-hidden="true" tabindex="-1"></a>FONT_PRIMARY <span class="op">=</span> BRAND.typography.base.model_dump()[<span class="st">"family"</span>]</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-12" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-12-5" class="code-annotation-target"><a href="#annotated-cell-12-5" aria-hidden="true" tabindex="-1"></a>COLOR_BACKGROUND <span class="op">=</span> BRAND.color.background</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-12" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-12" data-code-lines="4" data-code-annotation="1">Import the brand data and extract the <code>family</code> from <code>typography</code></span>
</dd>
<dt data-target-cell="annotated-cell-12" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-12" data-code-lines="5" data-code-annotation="2">Import other components, e.g.&nbsp;<code>color</code></span>
</dd>
</dl>
</div>
</div>
<p>That’s nice because if we want to change the font we can just edit the brand.yml configuration, and these changes will automatically propagate throughout any connected document like this one.</p>
<p>We can also connect other components like using the the brand’s color as our plot background, which will make it the same as the surrounding background from our quarto website.</p>
<p>Read more about <code>Brand</code> <a href="https://posit-dev.github.io/brand-yml/">here</a>.</p>
</section>
<section id="mizani-for-axis-breaks-and-labels" class="level3" data-number="3.5.2">
<h3 data-number="3.5.2" class="anchored" data-anchor-id="mizani-for-axis-breaks-and-labels"><span class="header-section-number">3.5.2</span> <code>mizani</code> for axis breaks and labels</h3>
<p>The axis breaks and labels for Plotnine graphs can be easily customized using <a href="https://mizani.readthedocs.io/en/stable/"><code>mizani</code></a>, which is the “<a href="https://scales.r-lib.org/">scales</a>” package for python.</p>
<p>We’re going to use <code>mizani.breaks.breaks_date_width</code> to put breaks for each year, and <code>mizani.labels.label_date</code> to drop the “month” part of the date.</p>
<div id="4cabb5de" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-13"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-13-1"><a href="#annotated-cell-13-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mizani.labels <span class="im">as</span> ml</span>
<span id="annotated-cell-13-2"><a href="#annotated-cell-13-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mizani.breaks <span class="im">as</span> mb</span>
<span id="annotated-cell-13-3"><a href="#annotated-cell-13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-13-4"><a href="#annotated-cell-13-4" aria-hidden="true" tabindex="-1"></a>plot <span class="op">=</span> (</span>
<span id="annotated-cell-13-5"><a href="#annotated-cell-13-5" aria-hidden="true" tabindex="-1"></a>    ggplot(</span>
<span id="annotated-cell-13-6"><a href="#annotated-cell-13-6" aria-hidden="true" tabindex="-1"></a>        labour_processed_cutted.<span class="bu">filter</span>(</span>
<span id="annotated-cell-13-7"><a href="#annotated-cell-13-7" aria-hidden="true" tabindex="-1"></a>            pl.col(<span class="st">"YEAR"</span>) <span class="op">&gt;=</span> FILTER_YEAR[<span class="dv">0</span>], pl.col(<span class="st">"YEAR"</span>) <span class="op">&lt;=</span> FILTER_YEAR[<span class="dv">1</span>]</span>
<span id="annotated-cell-13-8"><a href="#annotated-cell-13-8" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="annotated-cell-13-9"><a href="#annotated-cell-13-9" aria-hidden="true" tabindex="-1"></a>        aes(x<span class="op">=</span><span class="st">"DATE_YMD"</span>, y<span class="op">=</span><span class="st">"centered_rank_across_industry"</span>, fill<span class="op">=</span><span class="st">"PDIFF_BINNED"</span>),</span>
<span id="annotated-cell-13-10"><a href="#annotated-cell-13-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="annotated-cell-13-11"><a href="#annotated-cell-13-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> geom_tile(color<span class="op">=</span><span class="st">"white"</span>, height<span class="op">=</span><span class="fl">0.95</span>)</span>
<span id="annotated-cell-13-12"><a href="#annotated-cell-13-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme_tufte()</span>
<span id="annotated-cell-13-13"><a href="#annotated-cell-13-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme(</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-13" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-13-14" class="code-annotation-target"><a href="#annotated-cell-13-14" aria-hidden="true" tabindex="-1"></a>        text<span class="op">=</span>element_text(family<span class="op">=</span>FONT_PRIMARY),</span>
<span id="annotated-cell-13-15"><a href="#annotated-cell-13-15" aria-hidden="true" tabindex="-1"></a>        figure_size<span class="op">=</span>FIGURE_THEME_SIZE,</span>
<span id="annotated-cell-13-16"><a href="#annotated-cell-13-16" aria-hidden="true" tabindex="-1"></a>        axis_text_y<span class="op">=</span>element_text(family<span class="op">=</span>FONT_SECONDARY),</span>
<span id="annotated-cell-13-17"><a href="#annotated-cell-13-17" aria-hidden="true" tabindex="-1"></a>        axis_text_x<span class="op">=</span>element_text(family<span class="op">=</span>FONT_SECONDARY),</span>
<span id="annotated-cell-13-18"><a href="#annotated-cell-13-18" aria-hidden="true" tabindex="-1"></a>        axis_title_y<span class="op">=</span>element_text(weight<span class="op">=</span><span class="dv">300</span>),</span>
<span id="annotated-cell-13-19"><a href="#annotated-cell-13-19" aria-hidden="true" tabindex="-1"></a>        legend_justification_right<span class="op">=</span><span class="dv">1</span>,</span>
<span id="annotated-cell-13-20"><a href="#annotated-cell-13-20" aria-hidden="true" tabindex="-1"></a>        legend_position<span class="op">=</span><span class="st">"right"</span>,</span>
<span id="annotated-cell-13-21"><a href="#annotated-cell-13-21" aria-hidden="true" tabindex="-1"></a>        legend_text_position<span class="op">=</span><span class="st">"right"</span>,</span>
<span id="annotated-cell-13-22"><a href="#annotated-cell-13-22" aria-hidden="true" tabindex="-1"></a>        legend_title_position<span class="op">=</span><span class="st">"top"</span>,</span>
<span id="annotated-cell-13-23"><a href="#annotated-cell-13-23" aria-hidden="true" tabindex="-1"></a>        legend_key_spacing<span class="op">=</span><span class="dv">0</span>,</span>
<span id="annotated-cell-13-24"><a href="#annotated-cell-13-24" aria-hidden="true" tabindex="-1"></a>        legend_key_width<span class="op">=</span><span class="dv">15</span>,</span>
<span id="annotated-cell-13-25"><a href="#annotated-cell-13-25" aria-hidden="true" tabindex="-1"></a>        legend_key_height<span class="op">=</span><span class="dv">15</span>,</span>
<span id="annotated-cell-13-26"><a href="#annotated-cell-13-26" aria-hidden="true" tabindex="-1"></a>        legend_text<span class="op">=</span>element_text(size<span class="op">=</span><span class="dv">8</span>, family<span class="op">=</span>FONT_SECONDARY),</span>
<span id="annotated-cell-13-27"><a href="#annotated-cell-13-27" aria-hidden="true" tabindex="-1"></a>        legend_title<span class="op">=</span>element_blank(),</span>
<span id="annotated-cell-13-28"><a href="#annotated-cell-13-28" aria-hidden="true" tabindex="-1"></a>        plot_title<span class="op">=</span>element_text(ha<span class="op">=</span><span class="st">"left"</span>),</span>
<span id="annotated-cell-13-29"><a href="#annotated-cell-13-29" aria-hidden="true" tabindex="-1"></a>        plot_subtitle<span class="op">=</span>element_text(ha<span class="op">=</span><span class="st">"left"</span>, margin<span class="op">=</span>{<span class="st">"b"</span>: <span class="dv">1</span>, <span class="st">"units"</span>: <span class="st">"lines"</span>}),</span>
<span id="annotated-cell-13-30"><a href="#annotated-cell-13-30" aria-hidden="true" tabindex="-1"></a>        plot_background<span class="op">=</span>element_rect(fill<span class="op">=</span>COLOR_BACKGROUND, color<span class="op">=</span>COLOR_BACKGROUND),</span>
<span id="annotated-cell-13-31"><a href="#annotated-cell-13-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="annotated-cell-13-32"><a href="#annotated-cell-13-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> scale_fill_manual(values<span class="op">=</span>color_mapping, breaks<span class="op">=</span>order, labels<span class="op">=</span>legend_labels)</span>
<span id="annotated-cell-13-33"><a href="#annotated-cell-13-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> guides(fill<span class="op">=</span>guide_legend(ncol<span class="op">=</span><span class="dv">1</span>, reverse<span class="op">=</span><span class="va">True</span>))</span>
<span id="annotated-cell-13-34"><a href="#annotated-cell-13-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> scale_x_datetime(</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-13" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-13-35" class="code-annotation-target"><a href="#annotated-cell-13-35" aria-hidden="true" tabindex="-1"></a>        labels<span class="op">=</span>ml.label_date(<span class="st">"%Y"</span>),</span>
<span id="annotated-cell-13-36"><a href="#annotated-cell-13-36" aria-hidden="true" tabindex="-1"></a>        expand<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">0</span>),</span>
<span id="annotated-cell-13-37"><a href="#annotated-cell-13-37" aria-hidden="true" tabindex="-1"></a>        breaks<span class="op">=</span>mb.breaks_date_width(<span class="st">"1 years"</span>),</span>
<span id="annotated-cell-13-38"><a href="#annotated-cell-13-38" aria-hidden="true" tabindex="-1"></a>    )</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-13" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-13-39" class="code-annotation-target"><a href="#annotated-cell-13-39" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> labs(</span>
<span id="annotated-cell-13-40"><a href="#annotated-cell-13-40" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Sector Shifts: Where Canada's Jobs Are Moving"</span>,</span>
<span id="annotated-cell-13-41"><a href="#annotated-cell-13-41" aria-hidden="true" tabindex="-1"></a>        subtitle<span class="op">=</span>textwrap.fill(</span>
<span id="annotated-cell-13-42"><a href="#annotated-cell-13-42" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Track the number of industries gaining or losing jobs each month. Boxes are shaded based on percentage change from previous month in each industry's employment levels."</span>,</span>
<span id="annotated-cell-13-43"><a href="#annotated-cell-13-43" aria-hidden="true" tabindex="-1"></a>            width<span class="op">=</span><span class="dv">75</span>,</span>
<span id="annotated-cell-13-44"><a href="#annotated-cell-13-44" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="annotated-cell-13-45"><a href="#annotated-cell-13-45" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>,</span>
<span id="annotated-cell-13-46"><a href="#annotated-cell-13-46" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"&lt; SECTORS FALLING            SECTORS RISING &gt;"</span>,</span>
<span id="annotated-cell-13-47"><a href="#annotated-cell-13-47" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="annotated-cell-13-48"><a href="#annotated-cell-13-48" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="annotated-cell-13-49"><a href="#annotated-cell-13-49" aria-hidden="true" tabindex="-1"></a>plot</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-13" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-13" data-code-lines="14,16,17,26" data-code-annotation="1">Apply font family changes to the primary font in <code>theme(...)</code></span>
</dd>
<dt data-target-cell="annotated-cell-13" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-13" data-code-lines="35,37" data-code-annotation="2">Use <code>mizani</code> to format labels to show only the year in <code>scale_x_datetime</code></span>
</dd>
<dt data-target-cell="annotated-cell-13" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-13" data-code-lines="39" data-code-annotation="3">Add <code>title</code>, <code>subtitle</code> and wrap long lines with the help of <code>textwrap</code></span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_develop_visualization_files/figure-html/cell-14-output-1.png" width="768" height="576" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="conclusion-of-the-base-graphic" class="level2" data-number="3.6">
<h2 data-number="3.6" class="anchored" data-anchor-id="conclusion-of-the-base-graphic"><span class="header-section-number">3.6</span> Conclusion of the base graphic</h2>
<p>And that concludes generating the employment heatmap. However, I found this graphic to be lacking in depth: what are the industries that are growing and shrinking? And by how much?</p>
</section>
</section>
<section id="adding-more-layers" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Adding more layers</h1>
<p>It is tough to embed even more additional information into this already information dense graphic.</p>
<p>So my strategy here is to highlight one industry at a time.</p>
<section id="highlighting-an-industry" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="highlighting-an-industry"><span class="header-section-number">4.1</span> Highlighting an Industry</h2>
<div id="98418df8" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-14"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><a class="code-annotation-anchor" data-target-cell="annotated-cell-14" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-14-1" class="code-annotation-target"><a href="#annotated-cell-14-1" aria-hidden="true" tabindex="-1"></a>INDUSTRY <span class="op">=</span> <span class="st">'Wholesale and retail trade [41, 44-45]'</span></span>
<span id="annotated-cell-14-2"><a href="#annotated-cell-14-2" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-14" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-14-3" class="code-annotation-target"><a href="#annotated-cell-14-3" aria-hidden="true" tabindex="-1"></a>plot_data_subsetted <span class="op">=</span> labour_processed_cutted.<span class="bu">filter</span>(</span>
<span id="annotated-cell-14-4"><a href="#annotated-cell-14-4" aria-hidden="true" tabindex="-1"></a>    pl.col(<span class="st">"YEAR"</span>) <span class="op">&gt;=</span> FILTER_YEAR[<span class="dv">0</span>],                                     </span>
<span id="annotated-cell-14-5"><a href="#annotated-cell-14-5" aria-hidden="true" tabindex="-1"></a>    pl.col(<span class="st">"YEAR"</span>) <span class="op">&lt;=</span> FILTER_YEAR[<span class="dv">1</span>],                                     </span>
<span id="annotated-cell-14-6"><a href="#annotated-cell-14-6" aria-hidden="true" tabindex="-1"></a>    pl.col(<span class="st">'Industry'</span>) <span class="op">==</span> INDUSTRY                                       </span>
<span id="annotated-cell-14-7"><a href="#annotated-cell-14-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="annotated-cell-14-8"><a href="#annotated-cell-14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-14-9"><a href="#annotated-cell-14-9" aria-hidden="true" tabindex="-1"></a>plot_highlight_industry <span class="op">=</span> (</span>
<span id="annotated-cell-14-10"><a href="#annotated-cell-14-10" aria-hidden="true" tabindex="-1"></a>    plot</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-14" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-14-11" class="code-annotation-target"><a href="#annotated-cell-14-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> geom_point(data<span class="op">=</span>plot_data_subsetted, color<span class="op">=</span><span class="st">'black'</span>, fill<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="annotated-cell-14-12"><a href="#annotated-cell-14-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> labs(title <span class="op">=</span> INDUSTRY, subtitle <span class="op">=</span> <span class="st">''</span>)</span>
<span id="annotated-cell-14-13"><a href="#annotated-cell-14-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="annotated-cell-14-14"><a href="#annotated-cell-14-14" aria-hidden="true" tabindex="-1"></a>plot_highlight_industry</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-14" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-14" data-code-lines="1" data-code-annotation="1">Specify indsutry</span>
</dd>
<dt data-target-cell="annotated-cell-14" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-14" data-code-lines="3" data-code-annotation="2">Subset data</span>
</dd>
<dt data-target-cell="annotated-cell-14" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-14" data-code-lines="11" data-code-annotation="3">Add the subsetted data to another <code>geom_point</code> layer</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_develop_visualization_files/figure-html/cell-15-output-1.png" width="768" height="576" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Great, now we can indicate a specific industry’s data onto the graphic.</p>
<p>But I personally still find the graphic a bit unsatisfying as it is hard to read out any specific numbers from it.</p>
</section>
<section id="adding-statistics-to-the-plot" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="adding-statistics-to-the-plot"><span class="header-section-number">4.2</span> Adding statistics to the plot</h2>
<p>I think adding a few raw numbers to the graphic will leave a more impactful impression on readers.</p>
<p>In this section I compute the change, and % change for the last:</p>
<ul>
<li>1 month</li>
<li>5 months</li>
<li>1 year</li>
<li>5 years</li>
</ul>
<div id="45ebd34a" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define offsets</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>offsets <span class="op">=</span> {</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"1M"</span>: <span class="dv">1</span>,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"5M"</span>: <span class="dv">5</span>,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"1Y"</span>: <span class="dv">12</span>,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"5Y"</span>: <span class="dv">60</span>,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort by industry + date</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>labour_offset <span class="op">=</span> labour_processed_cutted</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>labour_offset <span class="op">=</span> labour_offset.sort([<span class="st">"Industry"</span>, <span class="st">"DATE_YMD"</span>])</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute diffs and %diffs for each horizon</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> label, months <span class="kw">in</span> offsets.items():</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    labour_offset <span class="op">=</span> labour_offset.with_columns(</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>        [</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>            (pl.col(<span class="st">"DATE_YMD"</span>).shift(months).alias(<span class="ss">f"DATE_YMD_</span><span class="sc">{</span>label<span class="sc">}</span><span class="ss">"</span>)),</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>            (pl.col(<span class="st">"VALUE"</span>).shift(months).over(<span class="st">"Industry"</span>).alias(<span class="ss">f"VALUE_</span><span class="sc">{</span>label<span class="sc">}</span><span class="ss">"</span>)),</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>            (pl.col(<span class="st">"VALUE"</span>) <span class="op">-</span> pl.col(<span class="st">"VALUE"</span>).shift(months).over(<span class="st">"Industry"</span>)).alias(</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"DIFF_</span><span class="sc">{</span>label<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>            (</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>                (pl.col(<span class="st">"VALUE"</span>) <span class="op">-</span> pl.col(<span class="st">"VALUE"</span>).shift(months).over(<span class="st">"Industry"</span>))</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>                <span class="op">/</span> pl.col(<span class="st">"VALUE"</span>).shift(months).over(<span class="st">"Industry"</span>)</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>                <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>            ).alias(<span class="ss">f"PDIFF_</span><span class="sc">{</span>label<span class="sc">}</span><span class="ss">"</span>),</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a><span class="co"># convert to dictionary for easier access</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>stats <span class="op">=</span> labour_offset.<span class="bu">filter</span>(</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>    pl.col(<span class="st">"Industry"</span>) <span class="op">==</span> INDUSTRY, pl.col(<span class="st">"DATE_YMD"</span>) <span class="op">==</span> pl.col(<span class="st">"DATE_YMD"</span>).<span class="bu">max</span>()</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>).to_dicts()[<span class="dv">0</span>]</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a><span class="co"># generate a string that we can use as a subtitle</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>periods <span class="op">=</span> [</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"</span><span class="sc">{</span>stats[<span class="st">'DIFF_1M'</span>]<span class="sc">:&lt;+4.0f}</span><span class="ss"> </span><span class="sc">{</span><span class="ss">f'(</span><span class="sc">{</span>stats[<span class="st">"PDIFF_1M"</span>]<span class="sc">:+.2f}</span><span class="ss">%)'</span><span class="sc">:&lt;10}</span><span class="ss"> 1 Month"</span>,</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"</span><span class="sc">{</span>stats[<span class="st">'DIFF_5M'</span>]<span class="sc">:&lt;+4.0f}</span><span class="ss"> </span><span class="sc">{</span><span class="ss">f'(</span><span class="sc">{</span>stats[<span class="st">"PDIFF_5M"</span>]<span class="sc">:+.2f}</span><span class="ss">%)'</span><span class="sc">:&lt;10}</span><span class="ss"> 5 Months"</span>,</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"</span><span class="sc">{</span>stats[<span class="st">'DIFF_1Y'</span>]<span class="sc">:&lt;+4.0f}</span><span class="ss"> </span><span class="sc">{</span><span class="ss">f'(</span><span class="sc">{</span>stats[<span class="st">"PDIFF_1Y"</span>]<span class="sc">:+.2f}</span><span class="ss">%)'</span><span class="sc">:&lt;10}</span><span class="ss"> 1 Year"</span>,</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"</span><span class="sc">{</span>stats[<span class="st">'DIFF_5Y'</span>]<span class="sc">:&lt;+4.0f}</span><span class="ss"> </span><span class="sc">{</span><span class="ss">f'(</span><span class="sc">{</span>stats[<span class="st">"PDIFF_5Y"</span>]<span class="sc">:+.2f}</span><span class="ss">%)'</span><span class="sc">:&lt;10}</span><span class="ss"> 5 Years"</span>,</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>subtitle_text <span class="op">=</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>.join(periods)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The plan is to add these into the plot as a subtitle. I would love to additionally set green and red colors to positive and negative values, but that isn’t currently possible in <code>plotnine</code>. However, <a href="https://github.com/has2k1/plotnine/issues/612">#612</a> suggests this may be possible in the longer term.</p>
<div id="bbcf8d4d" class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-16"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-16-1"><a href="#annotated-cell-16-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="annotated-cell-16-2"><a href="#annotated-cell-16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-16-3"><a href="#annotated-cell-16-3" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="annotated-cell-16-4"><a href="#annotated-cell-16-4" aria-hidden="true" tabindex="-1"></a>    ggplot(</span>
<span id="annotated-cell-16-5"><a href="#annotated-cell-16-5" aria-hidden="true" tabindex="-1"></a>        labour_processed_cutted.<span class="bu">filter</span>(</span>
<span id="annotated-cell-16-6"><a href="#annotated-cell-16-6" aria-hidden="true" tabindex="-1"></a>            pl.col(<span class="st">"YEAR"</span>) <span class="op">&gt;=</span> FILTER_YEAR[<span class="dv">0</span>], pl.col(<span class="st">"YEAR"</span>) <span class="op">&lt;=</span> FILTER_YEAR[<span class="dv">1</span>]</span>
<span id="annotated-cell-16-7"><a href="#annotated-cell-16-7" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="annotated-cell-16-8"><a href="#annotated-cell-16-8" aria-hidden="true" tabindex="-1"></a>        aes(x<span class="op">=</span><span class="st">"DATE_YMD"</span>, y<span class="op">=</span><span class="st">"centered_rank_across_industry"</span>, fill<span class="op">=</span><span class="st">"PDIFF_BINNED"</span>),</span>
<span id="annotated-cell-16-9"><a href="#annotated-cell-16-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="annotated-cell-16-10"><a href="#annotated-cell-16-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> geom_tile(color<span class="op">=</span><span class="st">"white"</span>, height<span class="op">=</span><span class="fl">0.95</span>)</span>
<span id="annotated-cell-16-11"><a href="#annotated-cell-16-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme_tufte()</span>
<span id="annotated-cell-16-12"><a href="#annotated-cell-16-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme(</span>
<span id="annotated-cell-16-13"><a href="#annotated-cell-16-13" aria-hidden="true" tabindex="-1"></a>        text<span class="op">=</span>element_text(family<span class="op">=</span>FONT_PRIMARY),</span>
<span id="annotated-cell-16-14"><a href="#annotated-cell-16-14" aria-hidden="true" tabindex="-1"></a>        figure_size<span class="op">=</span>FIGURE_THEME_SIZE,</span>
<span id="annotated-cell-16-15"><a href="#annotated-cell-16-15" aria-hidden="true" tabindex="-1"></a>        axis_text_y<span class="op">=</span>element_text(family<span class="op">=</span>FONT_SECONDARY),</span>
<span id="annotated-cell-16-16"><a href="#annotated-cell-16-16" aria-hidden="true" tabindex="-1"></a>        axis_text_x<span class="op">=</span>element_text(family<span class="op">=</span>FONT_SECONDARY),</span>
<span id="annotated-cell-16-17"><a href="#annotated-cell-16-17" aria-hidden="true" tabindex="-1"></a>        axis_title_y<span class="op">=</span>element_text(weight<span class="op">=</span><span class="dv">300</span>),</span>
<span id="annotated-cell-16-18"><a href="#annotated-cell-16-18" aria-hidden="true" tabindex="-1"></a>        legend_justification_right<span class="op">=</span><span class="dv">1</span>,</span>
<span id="annotated-cell-16-19"><a href="#annotated-cell-16-19" aria-hidden="true" tabindex="-1"></a>        legend_position<span class="op">=</span><span class="st">"right"</span>,</span>
<span id="annotated-cell-16-20"><a href="#annotated-cell-16-20" aria-hidden="true" tabindex="-1"></a>        legend_text_position<span class="op">=</span><span class="st">"right"</span>,</span>
<span id="annotated-cell-16-21"><a href="#annotated-cell-16-21" aria-hidden="true" tabindex="-1"></a>        legend_title_position<span class="op">=</span><span class="st">"top"</span>,</span>
<span id="annotated-cell-16-22"><a href="#annotated-cell-16-22" aria-hidden="true" tabindex="-1"></a>        legend_key_spacing<span class="op">=</span><span class="dv">0</span>,</span>
<span id="annotated-cell-16-23"><a href="#annotated-cell-16-23" aria-hidden="true" tabindex="-1"></a>        legend_key_width<span class="op">=</span><span class="dv">15</span>,</span>
<span id="annotated-cell-16-24"><a href="#annotated-cell-16-24" aria-hidden="true" tabindex="-1"></a>        legend_key_height<span class="op">=</span><span class="dv">15</span>,</span>
<span id="annotated-cell-16-25"><a href="#annotated-cell-16-25" aria-hidden="true" tabindex="-1"></a>        legend_text<span class="op">=</span>element_text(size<span class="op">=</span><span class="dv">8</span>, family<span class="op">=</span>FONT_SECONDARY),</span>
<span id="annotated-cell-16-26"><a href="#annotated-cell-16-26" aria-hidden="true" tabindex="-1"></a>        legend_title<span class="op">=</span>element_blank(),</span>
<span id="annotated-cell-16-27"><a href="#annotated-cell-16-27" aria-hidden="true" tabindex="-1"></a>        plot_title<span class="op">=</span>element_text(ha<span class="op">=</span><span class="st">"left"</span>),</span>
<span id="annotated-cell-16-28"><a href="#annotated-cell-16-28" aria-hidden="true" tabindex="-1"></a>        plot_subtitle<span class="op">=</span>element_text(ha<span class="op">=</span><span class="st">"left"</span>, margin<span class="op">=</span>{<span class="st">"b"</span>: <span class="dv">1</span>, <span class="st">"units"</span>: <span class="st">"lines"</span>}),</span>
<span id="annotated-cell-16-29"><a href="#annotated-cell-16-29" aria-hidden="true" tabindex="-1"></a>        plot_background<span class="op">=</span>element_rect(fill<span class="op">=</span>COLOR_BACKGROUND, color<span class="op">=</span>COLOR_BACKGROUND),</span>
<span id="annotated-cell-16-30"><a href="#annotated-cell-16-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="annotated-cell-16-31"><a href="#annotated-cell-16-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> scale_fill_manual(values<span class="op">=</span>color_mapping, breaks<span class="op">=</span>order, labels<span class="op">=</span>legend_labels)</span>
<span id="annotated-cell-16-32"><a href="#annotated-cell-16-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> guides(fill<span class="op">=</span>guide_legend(ncol<span class="op">=</span><span class="dv">1</span>, reverse<span class="op">=</span><span class="va">True</span>))</span>
<span id="annotated-cell-16-33"><a href="#annotated-cell-16-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> scale_x_datetime(</span>
<span id="annotated-cell-16-34"><a href="#annotated-cell-16-34" aria-hidden="true" tabindex="-1"></a>        labels<span class="op">=</span>ml.label_date(<span class="st">"%Y"</span>),</span>
<span id="annotated-cell-16-35"><a href="#annotated-cell-16-35" aria-hidden="true" tabindex="-1"></a>        expand<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">0</span>),</span>
<span id="annotated-cell-16-36"><a href="#annotated-cell-16-36" aria-hidden="true" tabindex="-1"></a>        breaks<span class="op">=</span>mb.breaks_date_width(<span class="st">"1 years"</span>),</span>
<span id="annotated-cell-16-37"><a href="#annotated-cell-16-37" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="annotated-cell-16-38"><a href="#annotated-cell-16-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> labs(</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-16" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-16-39" class="code-annotation-target"><a href="#annotated-cell-16-39" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span>re.sub(<span class="vs">r" </span><span class="ch">\[</span><span class="dv">.</span><span class="op">*?</span><span class="ch">\]</span><span class="dv">$</span><span class="vs">"</span>, <span class="st">""</span>, INDUSTRY),</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-16" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-16-40" class="code-annotation-target"><a href="#annotated-cell-16-40" aria-hidden="true" tabindex="-1"></a>        subtitle<span class="op">=</span>subtitle_text,</span>
<span id="annotated-cell-16-41"><a href="#annotated-cell-16-41" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>,</span>
<span id="annotated-cell-16-42"><a href="#annotated-cell-16-42" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"&lt; SECTORS FALLING            SECTORS RISING &gt;"</span>,</span>
<span id="annotated-cell-16-43"><a href="#annotated-cell-16-43" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="annotated-cell-16-44"><a href="#annotated-cell-16-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> geom_point(data<span class="op">=</span>plot_data_subsetted, color<span class="op">=</span><span class="st">"black"</span>, fill<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="annotated-cell-16-45"><a href="#annotated-cell-16-45" aria-hidden="true" tabindex="-1"></a>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-16" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-16" data-code-lines="39" data-code-annotation="1">Use inline regex to remove the trailing special characters</span>
</dd>
<dt data-target-cell="annotated-cell-16" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-16" data-code-lines="40" data-code-annotation="2">add <code>subtitle_text</code> to <code>labs</code></span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_develop_visualization_files/figure-html/cell-17-output-1.png" width="768" height="576" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="appendix-things-that-didnt-work" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Appendix: Things that didn’t work</h1>
<p>This section is a non-exhaustive list problems I wasn’t able to solve with <code>plotnine</code>.</p>
<p>Note that this tutorial was made with <code>plotnine</code> version <code>0.15.0</code>. I fully expect that this appendix will likely very quickly become irrelevant with the many anticipated improvements that are coming to <code>plotnine</code> in the near future.</p>
<section id="horizontal-legend-with-horizontal-legend-text" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="horizontal-legend-with-horizontal-legend-text"><span class="header-section-number">5.1</span> Horizontal legend with horizontal legend text</h2>
<p>Initially I wanted a horizontal legend for the colors. But in order to remove the whitespace between keys, I discovered that the text needs to be smaller than the legend keys, otherwise they “push” the legend keys apart in uneven manner. I attempted to (<em>unsuccesfully</em>) address this by making the legend text small, eliminating as much text as possible (e.g.&nbsp;removing the “%” characters for <code>-0.50</code> and <code>0.50</code>), and lastly increasing the legend key size.</p>
<p>But it still didn’t really work out the way I hoped, so I stuck with a vertical legend instead.</p>
<div id="19c32fd0" class="cell" data-execution_count="17">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_develop_visualization_files/figure-html/cell-18-output-1.png" width="768" height="576" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="composing-in-plotnine-is-not-like-rs-patchwork" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="composing-in-plotnine-is-not-like-rs-patchwork"><span class="header-section-number">5.2</span> Composing in plotnine is not like R’s patchwork</h2>
<p>I wanted to add a line plot of employment numbers to the heatmap. Given the similar syntax in plotnine’s <a href="https://plotnine.org/guide/plot-composition.html">compose</a> to R’s <a href="https://patchwork.data-imaginist.com/">patchwork</a>, I thought the behaviour would be similar.</p>
<p>One discrepancy is that there is no way to specify the relative size of component plots. But this might be addressed very soon <a href="https://github.com/has2k1/plotnine/pull/980">#980</a></p>
<p>It is possible to (rather labourously) pad plots by using <code>plot_spacer</code>s, which I attemp unsuccessfully below:</p>
<div id="efe510b0" class="cell" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>line_plot <span class="op">=</span> (</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    ggplot(</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>        labour_processed_cutted.<span class="bu">filter</span>(</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>            pl.col(<span class="st">"YEAR"</span>) <span class="op">&gt;=</span> FILTER_YEAR[<span class="dv">0</span>],</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>            pl.col(<span class="st">"YEAR"</span>) <span class="op">&lt;=</span> FILTER_YEAR[<span class="dv">1</span>],</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>            pl.col(<span class="st">"Industry"</span>).is_in([<span class="st">"Total employed, all industries"</span>]),</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>        aes(x<span class="op">=</span><span class="st">"DATE_YMD"</span>, y<span class="op">=</span><span class="st">"VALUE"</span>),</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> geom_line(color<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme_tufte()</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme(</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>        legend_position<span class="op">=</span><span class="st">"none"</span>,</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>        plot_title<span class="op">=</span>element_text(size<span class="op">=</span><span class="dv">10</span>, ha<span class="op">=</span><span class="st">"left"</span>),</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>        axis_ticks_length<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>        axis_ticks_major_y<span class="op">=</span>element_line(),</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>        axis_text_y<span class="op">=</span>element_text(size<span class="op">=</span><span class="dv">8</span>, margin<span class="op">=</span>{<span class="st">"r"</span>: <span class="dv">2</span>, <span class="st">"l"</span>: <span class="dv">2</span>, <span class="st">"units"</span>: <span class="st">"pt"</span>}),</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>        plot_background<span class="op">=</span>element_rect(fill<span class="op">=</span>COLOR_BACKGROUND, color<span class="op">=</span>COLOR_BACKGROUND),</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> scale_y_continuous(</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>        breaks<span class="op">=</span>mb.breaks_extended(<span class="dv">3</span>),</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>        labels<span class="op">=</span><span class="kw">lambda</span> x: [<span class="st">"</span><span class="sc">{:.0f}</span><span class="st">K"</span>.<span class="bu">format</span>(xi <span class="op">/</span> <span class="dv">1000</span>) <span class="cf">for</span> xi <span class="kw">in</span> x],</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> labs(title<span class="op">=</span><span class="st">"Employment Rate"</span>)</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotnine.composition <span class="im">import</span> Stack, plot_spacer</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>p1 <span class="op">=</span> Stack(</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>        line_plot <span class="op">+</span> scale_x_datetime(expand<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">0</span>)),</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>        plot_spacer(),</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>        plot_spacer(),</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>        plot_spacer(),</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>p2 <span class="op">=</span> (</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>    plot_highlight_industry</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme(plot_title<span class="op">=</span>element_blank(), plot_subtitle<span class="op">=</span>element_blank())</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> scale_x_datetime(expand<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>Stack([p1, p2]) <span class="op">&amp;</span> scale_x_datetime(expand<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="op">&amp;</span> theme_bw() <span class="op">&amp;</span> theme(</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>    plot_background<span class="op">=</span>element_rect(fill<span class="op">=</span>COLOR_BACKGROUND, color<span class="op">=</span>COLOR_BACKGROUND)</span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>) </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/runner/work/labourcan/labourcan/.venv/lib/python3.13/site-packages/plotnine/scales/scales.py:48: PlotnineWarning: Scale for 'x' is already present.
Adding another scale for 'x',
which will replace the existing scale.
</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_develop_visualization_files/figure-html/cell-19-output-2.png" width="672" height="480" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The x axes don’t automatically line up</p>
<p>This can be fixed by ensuring <code>expand</code> and the <code>limits</code> is the same:</p>
<div id="a5f1f0e1" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>Stack([plot_highlight_industry, line_plot]) <span class="op">&amp;</span> scale_x_datetime(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    expand<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>) <span class="op">&amp;</span> theme_bw() <span class="op">&amp;</span> theme(</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    plot_background<span class="op">=</span>element_rect(fill<span class="op">=</span>COLOR_BACKGROUND, color<span class="op">=</span>COLOR_BACKGROUND)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/runner/work/labourcan/labourcan/.venv/lib/python3.13/site-packages/plotnine/scales/scales.py:48: PlotnineWarning: Scale for 'x' is already present.
Adding another scale for 'x',
which will replace the existing scale.
</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_develop_visualization_files/figure-html/cell-20-output-2.png" width="672" height="480" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>But if we add <code>plot_spacer()</code>s then it won’t line up:</p>
<div id="b799cf98" class="cell" data-execution_count="20">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>Stack([plot_highlight_industry, p1]) <span class="op">&amp;</span> scale_x_datetime(</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    expand<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>) <span class="op">&amp;</span> theme_bw() <span class="op">&amp;</span> theme(</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    plot_background<span class="op">=</span>element_rect(fill<span class="op">=</span>COLOR_BACKGROUND, color<span class="op">=</span>COLOR_BACKGROUND)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/runner/work/labourcan/labourcan/.venv/lib/python3.13/site-packages/plotnine/scales/scales.py:48: PlotnineWarning: Scale for 'x' is already present.
Adding another scale for 'x',
which will replace the existing scale.
</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_develop_visualization_files/figure-html/cell-21-output-2.png" width="672" height="480" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Possibly there are some complexities that I don’t fully understand <a href="https://github.com/has2k1/plotnine/issues/959">#959</a></p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/wvictor14\.github\.io\/labourcan\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>